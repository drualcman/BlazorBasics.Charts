// BarChartWithPercentage.razor
@using System.Linq

<div class="bar-chart-container">
    <div class="chart-title">MobileAP Subs vs. Monthly Active Users</div>
    
    <div class="chart-legend">
        <div class="legend-item">
            <span class="legend-color active-users"></span>
            <span>Active Users</span>
        </div>
        <div class="legend-item">
            <span class="legend-color non-active-users"></span>
            <span>Non-Active Users</span>
        </div>
        <div class="legend-item">
            <span class="legend-line"></span>
            <span>% Active</span>
        </div>
    </div>
    
    <div class="chart-area">
        <svg class="chart-svg" xmlns="http://www.w3.org/2000/svg">
            @{
                // Constantes para el layout
                const int margin = 40;
                const int chartHeight = 300;
                const int barWidth = 50;
                const int spacing = 30;
                
                // Calcular valores máximos
                var maxTotal = Data.Max(x => x.ActiveUsers + x.NonActiveUsers);
                var points = new List<(double X, double Y)>();
                var totalWidth = (Data.Count * (barWidth + spacing)) + margin;
            }
            
            <!-- Eje X -->
            <line x1="@margin" y1="@(chartHeight + margin)" x2="@(totalWidth)" y2="@(chartHeight + margin)" stroke="#ccc" stroke-width="1" />
            
            @for (var i = 0; i < Data.Count; i++)
            {
                var item = Data[i];
                var total = item.ActiveUsers + item.NonActiveUsers;
                var activePercentage = total > 0 ? (item.ActiveUsers * 100.0 / total) : 0;
                
                // Altura de la columna (proporcional al máximo)
                var columnHeight = total * chartHeight / maxTotal;
                
                // Posiciones
                var x = margin + (i * (barWidth + spacing));
                var yBase = margin + chartHeight;
                var yTop = yBase - columnHeight;
                
                // Barra de usuarios activos
                var activeHeight = columnHeight * activePercentage / 100;
                <rect x="@x" y="@(yBase - activeHeight)" 
                      width="@barWidth" 
                      height="@activeHeight" 
                      fill="#4e79a7" />
                
                // Barra de usuarios inactivos
                <rect x="@x" 
                      y="@yTop" 
                      width="@barWidth" 
                      height="@(columnHeight - activeHeight)" 
                      fill="#f28e2b" />
                
                // Punto de porcentaje activo (en el borde entre las dos barras)
                var pointX = x + (barWidth / 2);
                var pointY = yBase - activeHeight;
                points.Add((pointX, pointY));
                
                <circle cx="@pointX" cy="@pointY" r="5" fill="#e15759" />
                
                // Etiqueta del porcentaje activo
                @(new MarkupString(SvgHelper.CreateSvgText($"{(int)activePercentage}%", pointX, (int)(pointY - 10), "middle")))
                
                // Etiqueta del mes
                @(new MarkupString(SvgHelper.CreateSvgText(item.Month, (x + (barWidth / 2)), (int)(chartHeight + margin + 20), "middle")))

                
                // Etiqueta del total (opcional)
                @(new MarkupString(SvgHelper.CreateSvgText($"{(total / 1000).ToString("N0")}%", (x + (barWidth / 2)), (int)(chartHeight + margin + 35), "middle")))
            }
            
            <!-- Línea que conecta los puntos del porcentaje activo -->
            <polyline points="@string.Join(" ", points.Select(p => $"{p.X},{p.Y}"))" 
                     fill="none" stroke="#e15759" stroke-width="2" />
        </svg>
    </div>
</div>
