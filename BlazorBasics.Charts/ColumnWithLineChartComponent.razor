// BarChartWithPercentage.razor
@using System.Linq

<div class="bar-chart-container">
    <div class="chart-title">MobileAP Subs vs. Monthly Active Users</div>
    
    <div class="chart-legend">
        <div class="legend-item">
            <span class="legend-color active-users"></span>
            <span>Active Users</span>
        </div>
        <div class="legend-item">
            <span class="legend-color non-active-users"></span>
            <span>Non-Active Users</span>
        </div>
        <div class="legend-item">
            <span class="legend-line"></span>
            <span>% of Grand Total</span>
        </div>
    </div>
    
    <div class="chart-area">
        <svg class="chart-svg" xmlns="http://www.w3.org/2000/svg">
            @{
                // Constantes para el layout
                const int margin = 40;
                const int chartHeight = 300;
                const int barWidth = 50;
                const int spacing = 30;
                
                // Calcular valores
                var maxColumnTotal = Data.Max(x => x.ActiveUsers + x.NonActiveUsers);
                var grandTotal = Data.Sum(x => x.ActiveUsers + x.NonActiveUsers);
                var points = new List<(double X, double Y)>();
                var totalWidth = (Data.Count * (barWidth + spacing)) + margin;
            }
            
            <!-- Eje X -->
            <line x1="@margin" y1="@(chartHeight + margin)" x2="@(totalWidth)" y2="@(chartHeight + margin)" stroke="#ccc" stroke-width="1" />
            
            @for (var i = 0; i < Data.Count; i++)
            {
                var item = Data[i];
                var columnTotal = item.ActiveUsers + item.NonActiveUsers;
                var activePercentage = columnTotal > 0 ? (item.ActiveUsers * 100.0 / columnTotal) : 0;
                var columnHeight = columnTotal * chartHeight / maxColumnTotal;
                var grandTotalPercentage = columnTotal * 100.0 / grandTotal;
                
                // Posiciones
                var x = margin + (i * (barWidth + spacing));
                var yBase = margin + chartHeight;
                
                // Barra de usuarios activos
                var activeHeight = columnHeight * activePercentage / 100;
                <rect x="@x" y="@(yBase - columnHeight)" 
                      width="@barWidth" 
                      height="@activeHeight" 
                      fill="#4e79a7" />
                
                // Barra de usuarios inactivos
                <rect x="@x" 
                      y="@(yBase - columnHeight + activeHeight)" 
                      width="@barWidth" 
                      height="@(columnHeight - activeHeight)" 
                      fill="#f28e2b" />
                
                // Punto del porcentaje del total general (para la línea)
                var pointX = x + (barWidth / 2);
                var pointY = yBase - (chartHeight * grandTotalPercentage / 100);
                points.Add((pointX, pointY));
                
                <circle cx="@pointX" cy="@pointY" r="5" fill="#e15759" />
                
                // Etiqueta del porcentaje activo (dentro de la barra)
                @(new MarkupString(SvgHelper.CreateSvgText($"{(int)activePercentage}%", pointX, (int)(yBase - columnHeight + activeHeight / 2), "middle")))
                
                // Etiqueta del porcentaje del total (junto al punto)
                @(new MarkupString(SvgHelper.CreateSvgText($"{(int)grandTotalPercentage}%", pointX, (int)(pointY - 10), "middle")))
                
                // Etiqueta del mes
                @(new MarkupString(SvgHelper.CreateSvgText(item.Month, (x + (barWidth / 2)), (int)(chartHeight + margin + 20), "middle")))
            }
            
            <!-- Línea que conecta los puntos del porcentaje del total -->
            <polyline points="@string.Join(" ", points.Select(p => $"{p.X},{p.Y}"))" 
                     fill="none" stroke="#e15759" stroke-width="2"/>
        </svg>
    </div>
</div>